' Gambas class file

'#################################################
' Software sotto licenza GPL v3 o superiore
' Software under GPL v3 o more licence
' Francesco "Ceskho OpenCode" Apruzzese
' per info o segnalazioni scrivere a :
' cescoap@gmail.com
'#################################################

PUBLIC SUB btAdd_Click()

  FMoneyManagerAdd.ShowDialog()

END

PUBLIC SUB Form_Resize()

  GridView1.Columns.Count = 5
  GridView1.Columns[0].Text = ("Data")
  GridView1.Columns[0].Width = GridView1.w / 5
  GridView1.Columns[1].Text = ("Importo giocato")
  GridView1.Columns[1].Width = GridView1.w / 5
  GridView1.Columns[2].Text = ("Importo vinto")
  GridView1.Columns[2].Width = GridView1.w / 5
  GridView1.Columns[3].Text = ("Lotteria")
  GridView1.Columns[3].Width = GridView1.w / 5
  GridView1.Columns[4].Text = ("Note")
  GridView1.Columns[4].Width = GridView1.w / 5

END

PUBLIC SUB bRefresh_Click()

  '-- graph data
  DIM graf AS NEW linegraf
  DIM datiused, datiwin, datitot AS NEW Float[]
  DIM dates AS NEW String[]
  '-- database data
  DIM $hConn AS NEW Connection
  DIM hres AS Result
  DIM sql, $data AS String
  DIM i AS Integer

  IF tbUsed.Value = FALSE AND tbWin.Value = FALSE AND tbEarn.Value = FALSE THEN 
    pbUsed.Visible = FALSE
  ELSE 
    pbUsed.Visible = TRUE
  END IF

  GridView1.Clear()

  '-- open the connection
  WITH $hConn
    .Type = Management.DatabaseType
    .Host = Management.DatabasePath
  END WITH
  $hConn.Name = Management.DatabaseName
  $hConn.Open

  '-- set and use query
  sql = "SELECT * FROM money WHERE data BETWEEN " & CInt(Replace(Str(DateChooser1.Value), "/", "")) & " AND " & CInt(Replace(Str(DateChooser2.Value), "/", ""))
  ' FUNZIONA! sql = "SELECT * FROM money WHERE data LIKE " & CInt(Replace(Str(DateChooser1.Value), "/", ""))
  hres = $hconn.Exec(sql)

  '-- fill gridview with extracts data
  IF hres.Available = TRUE THEN
      GridView1.Columns.Count = 5
      GridView1.Rows.Count = hres.Count
      i = 0
      FOR EACH hres
        $data = Str(hres!data)
        $data = Left($data, 2) & "/" & Right(Left($data, 4), 2) & "/" & Right($data, 2)
        GridView1[i, 0].Text = $data
        GridView1[i, 1].Text = hres!used & Management.$value
        GridView1[i, 2].Text = hres!win & Management.$value
        GridView1[i, 3].Text = hres!lottery
        GridView1[i, 4].Text = hres!note
        IF tbUsed.Value THEN datiused.Add(CFloat(Replace(hres!used, ",", ".")))
        IF tbWin.Value THEN datiwin.Add(CFloat(Replace(hres!win, ",", ".")))
        IF tbEarn.Value THEN datitot.Add(CFloat(Replace(hres!win, ",", ".")) - CFloat(Replace(hres!used, ",", ".")))
        IF tbDate.Value THEN dates.Add($data)
        INC i
      NEXT
  ELSE
        GridView1.Columns.Count = 1
        GridView1.Rows.Count = 1
        GridView1[0, 0].Text = ("Nessun dato trovato!")
        GridView1[0, 0].Alignment = Align.Center
  END IF

  IF tbUsed.Value THEN graf.put(datiused, Color.Red, ("Importo giocato"))
  IF tbWin.Value THEN graf.put(datiwin, Color.Green, ("Importo vinto"))
  IF tbEarn.Value THEN graf.put(datitot, Color.DarkCyan, ("Guadagno"))
  
  IF cbGraph.Index = 0 THEN
    IF tbDate.Value THEN 
      pbUsed.Picture = graf.WRITE("", pbUsed.w, pbUsed.h, Color.white, FALSE, dates, FALSE)
    ELSE 
      pbUsed.Picture = graf.WRITE("", pbUsed.w, pbUsed.h, Color.white, FALSE,,, FALSE)
    END IF
  ELSE IF cbGraph.Index = 1 THEN 
    IF tbDate.Value THEN 
      pbUsed.Picture = graf.WriteBar("", pbUsed.w, pbUsed.h, Color.white, FALSE, dates, FALSE)
    ELSE 
      pbUsed.Picture = graf.WriteBar("", pbUsed.w, pbUsed.h, Color.white, FALSE,,, FALSE)
    END IF
  END IF

END

PUBLIC SUB Form_Open()

  cbGraph.Add(("Grafico a linea"), 0)
  cbGraph.Add(("Grafico a barre"), 1)

END
