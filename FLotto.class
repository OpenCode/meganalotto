' Gambas class file

'#################################################
' Software sotto licenza GPL v3 o superiore
' Software under GPL v3 o more licence
' Francesco "Ceskho OpenCode" Apruzzese
' per info o segnalazioni scrivere a :
' cescoap@gmail.com
'#################################################

'-- page ritardatari
'-- http://www.lottomaticaitalia.it/lotto/statistiche/numeriRitardatariTop10.html

MyDate AS String

PUBLIC SUB _new($Date AS String)
  
  MyDate = $Date
  
END

PUBLIC SUB Form_Open()

  ME.Center

  GridView1.Columns.Count = 6
  GridView1.Rows.Count = 11
  GridView1.Columns[0].Title = "Ruota"
  GridView1.Columns[1].Title = "1° estr"
  GridView1.Columns[2].Title = "2° estr"
  GridView1.Columns[3].Title = "3° estr"
  GridView1.Columns[4].Title = "4° estr"
  GridView1.Columns[5].Title = "5° estr"
  GridView1[0, 0].Text = "Bari"
  GridView1[1, 0].Text = "Cagliari"
  GridView1[1, 0].Background = Color.LightGray
  GridView1[2, 0].Text = "Firenze"
  GridView1[3, 0].Text = "Genova"
  GridView1[3, 0].Background = Color.LightGray
  GridView1[4, 0].Text = "Milano"
  GridView1[5, 0].Text = "Napoli"
  GridView1[5, 0].Background = Color.LightGray
  GridView1[6, 0].Text = "Palermo"
  GridView1[7, 0].Text = "Roma"
  GridView1[7, 0].Background = Color.LightGray
  GridView1[8, 0].Text = "Torino"
  GridView1[9, 0].Text = "Venezia"
  GridView1[9, 0].Background = Color.LightGray
  GridView1[10, 0].Text = "Nazionale"
  
  IF MyDate = "" THEN 
    PopolateWithLast()
  ELSE 
    PopolateWithChoose(MyDate)
  END IF

  FMain.Label2.Text = "Visualizzatore caricato"

END

PRIVATE SUB PopolateWithLast()
  
  DIM i AS Integer
  
  GridView1.Rows.Count = 11

    '-- if file exists the software didn't download it again.
  IF Exist("/tmp/estrazioni_ultime.do") = FALSE THEN
      SHELL "wget --directory-prefix=/tmp " & "http://www.lottomaticaitalia.it/lotto/estrazioni/estrazioni_ultime.do" WAIT
  END IF
  FOR i = 0 TO 10
      extract_number(45 + (13 * i))
  NEXT
  
END

PRIVATE SUB PopolateWithChoose(ChooseDate AS String)

  DIM $hConn AS NEW Connection
  DIM sql AS String
  DIM hres AS Result
  DIM i AS Integer

  WITH $hConn
    .Type = Management.DatabaseType
    .Host = Management.DatabasePath
  END WITH

  $hConn.Name = Management.LottoDatabaseName
  $hConn.Open

  sql = "SELECT * FROM " & Management.LottoDatabaseTableName & " WHERE date LIKE " & ChooseDate

  hres = $hconn.Exec(sql)  ' esegue la query

  IF hres.Available = FALSE THEN
    Message.Error("No data found")
    RETURN 
  END IF
   
  i = 0
  FOR EACH hres
    IF i MOD 2 <> 0 THEN 
      GridView1[i, 1].Background = Color.LightGray
      GridView1[i, 2].Background = Color.LightGray
      GridView1[i, 3].Background = Color.LightGray
      GridView1[i, 4].Background = Color.LightGray
      GridView1[i, 5].Background = Color.LightGray
    END IF
    GridView1[i, 1].Text = Split(hres!numbs, "-")[0]
    GridView1[i, 2].Text = Split(hres!numbs, "-")[1]
    GridView1[i, 3].Text = Split(hres!numbs, "-")[2]
    GridView1[i, 4].Text = Split(hres!numbs, "-")[3]
    GridView1[i, 5].Text = Split(hres!numbs, "-")[4]
    INC i
  NEXT
  
  $hconn.Close()
  
END

PRIVATE SUB extract_number(ruota AS Integer)

  DIM numeri AS String[5]

  numeri[0] = Split(File.Load("/tmp/estrazioni_ultime.do"), "\n")[ruota]
  INC ruota
  numeri[1] = Split(File.Load("/tmp/estrazioni_ultime.do"), "\n")[ruota]
  INC ruota
  numeri[2] = Split(File.Load("/tmp/estrazioni_ultime.do"), "\n")[ruota]
  INC ruota
  numeri[3] = Split(File.Load("/tmp/estrazioni_ultime.do"), "\n")[ruota]
  INC ruota
  numeri[4] = Split(File.Load("/tmp/estrazioni_ultime.do"), "\n")[ruota]
  WAIT
  PopolaGridView((ruota - 4), numeri)

END

PRIVATE FUNCTION Ripulisci(pulire AS String) AS String

  DIM restituisci AS String

  restituisci = Replace(pulire, "<td class=\"center\">", "")
  restituisci = Replace(restituisci, "</td>", "")

  RETURN Trim(restituisci)

END

PRIVATE FUNCTION PopolaGridView($ruota AS Integer, $numero AS String[])

  DIM i, j AS Integer
  
  IF $ruota = 45 THEN 
      j = 0
  ELSE IF $ruota = 58
      j = 1
  ELSE IF $ruota = 71
      j = 2
  ELSE IF $ruota = 84
      j = 3
  ELSE IF $ruota = 97
      j = 4
  ELSE IF $ruota = 110
      j = 5
  ELSE IF $ruota = 123
      j = 6
  ELSE IF $ruota = 136
      j = 7
  ELSE IF $ruota = 149
      j = 8
  ELSE IF $ruota = 162
      j = 9
  ELSE IF $ruota = 175
      j = 10
  END IF

  FOR i = 1 TO 5
      GridView1[j, i].Text = Ripulisci($numero[i - 1])
      IF ((j MOD 2) = 1) THEN GridView1[j, i].Background = Color.LightGray
  NEXT

END

PUBLIC SUB Form_Resize()

  DIM i AS Integer

  '-- ridimensiona righe e coonne per renderle omogenee
  FOR i = 0 TO 10
      GridView1.Rows[i].Height = GridView1.h / 11
  NEXT
  FOR i = 0 TO 5
      GridView1.Columns[i].Width = GridView1.w / 6
  NEXT

END